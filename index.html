<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONEN STUDIO | Logistics Engine</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root { 
            --accent: #F59E0B; 
            --apple-curve: cubic-bezier(0.4, 0, 0.2, 1);
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #000; 
            color: white; 
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        .glass { 
            background: rgba(255,255,255,0.02); 
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.08); 
            border-radius: 14px; 
            transition: all 0.3s var(--apple-curve); 
        }

        .memo-card { 
            width: 210mm; 
            min-height: 148.5mm; 
            background: white; 
            color: black; 
            margin: 0 auto 100px auto; 
            display: flex; 
            flex-direction: column; 
            padding: 12mm 14mm;
            position: relative; 
            transition: all 0.4s var(--apple-curve); 
            transform: scale(0.98); 
            opacity: 0.3;
            box-sizing: border-box; 
            border-radius: 8px;
            filter: blur(2px);
        }

        .memo-card.active { 
            transform: scale(1); opacity: 1; filter: blur(0);
            box-shadow: 0 40px 80px -15px rgba(0,0,0,0.8); 
        }

        .pill-btn {
            padding: 8px 16px;
            font-size: 9px;
            font-weight: 900;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 99px;
            transition: all 0.2s;
            cursor: pointer;
            color: rgba(255,255,255,0.4);
        }
        .pill-btn:hover { border-color: rgba(255,255,255,0.3); color: white; }
        .pill-btn.active-state { background: white; color: black; border-color: white; }
        
        #sync-indicator.online { color: #10b981; }
        #sync-indicator.offline { color: #ef4444; }
        #sync-indicator.syncing { color: #f59e0b; animation: pulse 2s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        @media print { 
            .no-print { display: none !important; } 
            body { background: white; height: auto; overflow: visible; }
            .memo-card { opacity: 1!important; transform: scale(1)!important; margin: 0 auto!important; box-shadow: none!important; filter: none!important; display: flex !important; border: none; } 
        }
        
        .custom-scroll::-webkit-scrollbar { width: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); }
    </style>
</head>
<body>

    <div class="flex h-screen overflow-hidden no-print">
        <aside class="w-80 bg-[#050505] border-r border-white/5 p-8 flex flex-col gap-8 custom-scroll overflow-y-auto">
            <div class="flex justify-between items-start">
                <div class="text-amber-500 font-black italic text-3xl tracking-tighter">ONEN.</div>
                <div id="sync-indicator" class="text-[10px] flex items-center gap-1.5 font-bold syncing mt-2">
                    <i class="fa-solid fa-circle text-[6px]"></i> <span>Checking...</span>
                </div>
            </div>
            
            <div id="ui-controls" class="hidden space-y-8">
                 <button id="btn-new-memo" class="w-full bg-white text-black py-4 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-amber-500 transition-all flex items-center justify-center gap-2">
                    <i class="fa-solid fa-plus"></i> Create New Memo
                </button>

                <div class="space-y-4">
                    <label class="text-[9px] uppercase font-black opacity-30 tracking-[0.3em]">Lifecycle</label>
                    <div class="flex flex-wrap gap-2">
                        <button data-action="setLifecycle" data-state="PENDING" class="pill-btn">Pending</button>
                        <button data-action="setLifecycle" data-state="UNPAID" class="pill-btn">Unpaid</button>
                        <button data-action="setLifecycle" data-state="PAID" class="pill-btn">Paid</button>
                    </div>
                </div>

                <div class="space-y-4">
                    <label class="text-[9px] uppercase font-black opacity-30 tracking-[0.3em]">Shipping Zone</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button data-action="setShip" data-val="60" data-tag="DHAKA" class="pill-btn">Dhaka</button>
                        <button data-action="setShip" data-val="120" data-tag="OUTSIDE" class="pill-btn">Outside</button>
                    </div>
                </div>

                <div class="border-t border-white/5 pt-6">
                    <label class="text-[9px] uppercase font-black opacity-30 tracking-[0.3em] mb-4 block">Recent Memos</label>
                    <div id="history-list" class="space-y-2 max-h-64 overflow-y-auto custom-scroll pr-2"></div>
                </div>
            </div>

            <div id="ui-loader" class="flex flex-col items-center justify-center flex-grow opacity-20">
                <div class="w-5 h-5 border-2 border-white/20 border-t-white rounded-full animate-spin"></div>
                <span class="text-[8px] uppercase tracking-widest mt-4">Connecting to Hub</span>
            </div>

            <button id="btn-retry-auth" class="hidden w-full border border-red-500/50 text-red-500 py-3 rounded-lg text-[10px] font-black uppercase tracking-widest mt-auto">
                Timeout: Reconnect?
            </button>
        </aside>

        <main class="flex-grow bg-[#0a0a0a] overflow-y-auto p-12 relative no-scrollbar">
            <div id="workspace" class="max-w-4xl mx-auto pb-48"></div>

            <div id="bar-controls" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 flex items-center gap-6 bg-white/5 backdrop-blur-3xl px-8 py-4 rounded-3xl border border-white/10 shadow-2xl z-50">
                <button onclick="window.print()" class="bg-white text-black px-10 py-3 rounded-xl text-[10px] font-black uppercase hover:scale-105 transition-all shadow-lg">Print Current</button>
            </div>
        </main>
    </div>

    <template id="memo-tpl">
        <div class="memo-card group">
            <div class="flex justify-between border-b-[6px] border-black pb-4 mb-8">
                <h1 class="text-6xl font-black italic tracking-tighter">ONEN</h1>
                <div class="text-right flex flex-col justify-end">
                    <div class="text-4xl font-black m-id tracking-tighter">#0000</div>
                    <div class="text-[9px] font-black opacity-40 m-date uppercase tracking-widest mt-1"></div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-12 mb-6">
                <div class="space-y-2">
                    <input class="m-name w-full border-none font-black text-2xl p-0 focus:ring-0 uppercase bg-transparent text-black" placeholder="RECIPIENT NAME">
                    <input class="m-phone w-full border-none font-bold text-xl p-0 focus:ring-0 bg-transparent text-black" placeholder="PHONE">
                    <textarea class="m-addr w-full border-none text-[12px] h-12 p-0 focus:ring-0 resize-none font-medium bg-transparent text-black" placeholder="ADDRESS"></textarea>
                </div>
                <div class="text-right">
                    <span class="m-tag border-[3px] border-black px-6 py-2 text-[11px] font-black italic tracking-widest inline-block uppercase">DHAKA</span>
                </div>
            </div>
            <div class="flex-grow">
                <table class="w-full text-[13px]">
                    <tbody class="m-rows font-bold"></tbody>
                </table>
            </div>
            <div class="mt-4 border-t-2 border-black pt-6 flex justify-between items-end">
                <div class="text-[8px] font-bold opacity-40 uppercase">7-Day Exchange | OneN Studio | Dhaka</div>
                <div class="text-right w-64">
                    <div class="flex justify-between text-[11px] font-bold mb-2"><span class="opacity-40 uppercase">Delivery</span><span class="m-ship-val">0</span></div>
                    <div class="flex justify-between border-t-[3px] border-black pt-3 font-black">
                        <span class="text-[12px] mt-2 uppercase italic">Total</span>
                        <div class="flex items-start"><span class="text-xl mt-1 mr-1">à§³</span><span class="text-5xl m-total tracking-tighter">0</span></div>
                    </div>
                </div>
            </div>
            <button class="m-delete-btn no-print absolute top-4 right-4 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-2"><i class="fa-solid fa-trash-can"></i></button>
        </div>
    </template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // SAFE CONFIG PARSING (Fixes ReferenceError)
        let firebaseConfig = {};
        try {
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        } catch (e) {
            console.error("Firebase Config missing or malformed");
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' && __app_id ? __app_id : 'onen-logistics-v2';

        let memos = [];
        let activeDocId = null;

        const Core = {
            async start() {
                this.updateSync('syncing', 'Authenticating...');
                
                // Wait for platform auth or fallback
                const initAuth = async () => {
                    try {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (token) {
                            await signInWithCustomToken(auth, token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Auth Exception:", e);
                        this.updateSync('offline', 'Auth Error');
                    }
                };

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        this.unlockUI();
                        this.initSync();
                    } else {
                        initAuth();
                    }
                });

                setTimeout(() => {
                    if (!auth.currentUser) document.getElementById('btn-retry-auth').classList.remove('hidden');
                }, 8000);

                document.getElementById('btn-retry-auth').onclick = () => location.reload();
            },

            updateSync(state, label) {
                const el = document.getElementById('sync-indicator');
                if(!el) return;
                el.className = `text-[10px] flex items-center gap-1.5 font-bold mt-2 ${state}`;
                el.querySelector('span').innerText = label;
            },

            unlockUI() {
                document.getElementById('ui-loader').classList.add('hidden');
                document.getElementById('ui-controls').classList.remove('hidden');
                document.getElementById('bar-controls').classList.remove('hidden');
                this.updateSync('online', 'Live');
            },

            initSync() {
                // RULE 1: STRICT PATHS
                const memoRef = collection(db, 'artifacts', appId, 'public', 'data', 'memos');
                
                onSnapshot(memoRef, (snap) => {
                    const data = [];
                    snap.forEach(d => data.push({ ...d.data(), docId: d.id }));
                    memos = data.sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0));
                    
                    if (memos.length > 0 && !activeDocId) activeDocId = memos[0].docId;
                    this.render();
                }, (err) => {
                    console.error("Sync Failure:", err);
                    this.updateSync('offline', 'Read Error');
                });
            },

            async createMemo() {
                const id = Date.now().toString();
                const newDoc = {
                    id: '#' + Math.floor(1000 + Math.random() * 9000),
                    date: new Date().toLocaleDateString('en-GB'),
                    name: '', phone: '', addr: '', ship: 60, tag: 'DHAKA',
                    status: 'PENDING', items: [], createdAt: Date.now()
                };
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'memos', id), newDoc);
                activeDocId = id;
            },

            render() {
                const workspace = document.getElementById('workspace');
                const history = document.getElementById('history-list');
                workspace.innerHTML = '';
                history.innerHTML = '';

                if (memos.length === 0) {
                    workspace.innerHTML = `<div class="text-white/10 text-[10px] font-black uppercase text-center mt-32">Database Empty. Click "+" to start.</div>`;
                    return;
                }

                memos.forEach(m => {
                    const isActive = m.docId === activeDocId;
                    const tpl = document.getElementById('memo-tpl').content.cloneNode(true);
                    const card = tpl.querySelector('.memo-card');
                    if (isActive) card.classList.add('active');

                    card.querySelector('.m-id').innerText = m.id;
                    card.querySelector('.m-date').innerText = m.date;
                    card.querySelector('.m-name').value = m.name || '';
                    card.querySelector('.m-phone').value = m.phone || '';
                    card.querySelector('.m-addr').value = m.addr || '';
                    card.querySelector('.m-ship-val').innerText = m.ship || 60;
                    card.querySelector('.m-tag').innerText = m.tag || 'DHAKA';

                    const upd = (k, v) => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'memos', m.docId), { [k]: v });
                    card.querySelector('.m-name').onchange = (e) => upd('name', e.target.value.toUpperCase());
                    card.querySelector('.m-phone').onchange = (e) => upd('phone', e.target.value);
                    card.querySelector('.m-addr').onchange = (e) => upd('addr', e.target.value);

                    let total = parseInt(m.ship || 60);
                    (m.items || []).forEach(item => total += (item.price * item.qty));
                    card.querySelector('.m-total').innerText = total.toLocaleString();

                    card.onclick = () => { activeDocId = m.docId; this.render(); };
                    card.querySelector('.m-delete-btn').onclick = async (e) => { 
                        e.stopPropagation(); 
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'memos', m.docId));
                    };

                    workspace.appendChild(card);

                    const hi = document.createElement('div');
                    hi.className = `p-3 glass cursor-pointer transition-all border-l-4 ${isActive ? 'border-amber-500 bg-white/5 opacity-100' : 'border-transparent opacity-40'}`;
                    hi.innerHTML = `<div class="text-[9px] font-black truncate">${m.name || 'UNNAMED'}</div><div class="text-[7px] opacity-50">${m.id}</div>`;
                    hi.onclick = () => { activeDocId = m.docId; this.render(); };
                    history.appendChild(hi);
                });
            }
        };

        document.getElementById('btn-new-memo').onclick = () => Core.createMemo();
        
        document.querySelectorAll('[data-action]').forEach(btn => {
            btn.onclick = () => {
                if (!activeDocId) return;
                const field = btn.dataset.action === 'setLifecycle' ? 'status' : 'ship';
                let val = btn.dataset.state || parseInt(btn.dataset.val);
                const data = { [field]: val };
                if (btn.dataset.tag) data.tag = btn.dataset.tag;
                updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'memos', activeDocId), data);
            };
        });

        window.onload = () => Core.start();
    </script>
</body>
</html>
