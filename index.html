<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONEN STUDIO | v97 Storage Fixed</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;800&display=swap');
        :root { --accent: #F59E0B; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020202; color: white; overflow: hidden; }
        .sidebar-view { transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .hidden-view { display: none; opacity: 0; }
        .glass-input { background: rgba(255,255,255,0.03); border: 1px solid #1a1a1a; color: white; border-radius: 12px; padding: 12px; font-size: 11px; width: 100%; outline: none; }
        .glass-input:focus { border-color: var(--accent); }
        .memo-card { width: 210mm; height: 148.5mm; background: white; color: black; margin: 0 auto; position: relative; transition: 0.3s; opacity: 0.2; transform: scale(0.95); }
        .memo-card.active { opacity: 1; transform: scale(1); border: 4px solid var(--accent); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #555; }
        .online { background: #10B981; box-shadow: 0 0 10px #10B981; }
        .custom-scroll::-webkit-scrollbar { width: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); }
        @media print { .no-print { display: none !important; } .memo-card { opacity: 1!important; transform: scale(1)!important; border: none!important; margin: 0!important; } }
    </style>
</head>
<body>

    <div class="flex h-screen">
        <aside id="sidebar" class="w-80 bg-[#080808] border-r border-white/5 flex flex-col p-6 overflow-hidden">
            <div class="flex items-center justify-between mb-8">
                <h1 class="text-xl font-black italic uppercase">ONEN STUDIO</h1>
                <div id="status-icon" class="status-dot"></div>
            </div>

            <div id="ops-view" class="sidebar-view space-y-6 flex flex-col flex-grow">
                <button onclick="Core.createNewMemo()" class="w-full bg-white text-black py-3 rounded-xl font-black text-[10px] uppercase">+ New Order</button>
                <textarea id="magic-box" oninput="Core.processMagic()" class="glass-input h-20 resize-none" placeholder="Paste Name, Phone, Address..."></textarea>
                
                <div class="flex-grow flex flex-col bg-white/5 rounded-2xl border border-white/5 p-4 overflow-hidden">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[9px] font-black text-amber-500 uppercase">Inventory</label>
                        <button onclick="UI.toggleView()" class="text-[8px] underline opacity-50">Manage Stock</button>
                    </div>
                    <input id="cat-search" oninput="Inventory.render()" class="glass-input mb-2 !py-2 text-[10px]" placeholder="Search SKU...">
                    <div id="cat-list" class="overflow-y-auto custom-scroll space-y-2"></div>
                </div>
            </div>

            <div id="inv-view" class="sidebar-view hidden-view space-y-4">
                <button onclick="UI.toggleView()" class="text-[9px] uppercase font-black text-amber-500 mb-2">‚Üê Back to Orders</button>
                <div class="bg-white/5 p-4 rounded-xl border border-white/10 space-y-2">
                    <input id="in-sku" class="glass-input" placeholder="SKU Code">
                    <input id="in-name" class="glass-input" placeholder="Product Name">
                    <input id="in-price" type="number" class="glass-input" placeholder="Price">
                    <input id="in-cols" class="glass-input" placeholder="Colors (Black, White)">
                    <input id="in-sizes" class="glass-input" placeholder="Sizes (M, L, XL)">
                    <button onclick="Inventory.saveToCloud()" class="w-full py-3 bg-amber-500 text-black font-black text-[10px] rounded-lg">SYNC TO CLOUD</button>
                </div>
                <div id="inv-list-full" class="h-64 overflow-y-auto custom-scroll space-y-2"></div>
            </div>
        </aside>

        <main class="flex-grow bg-[#050505] p-12 overflow-y-auto flex flex-col items-center">
            <div id="workspace" class="space-y-12 pb-40"></div>
            <div class="fixed bottom-10 flex gap-3 bg-black/80 p-3 rounded-2xl border border-white/10 backdrop-blur-xl no-print">
                <button onclick="Core.exportExcel()" class="px-6 py-3 bg-green-600/20 text-green-400 text-[10px] font-black rounded-xl">EXCEL</button>
                <button onclick="Core.exportPDF()" class="px-6 py-3 bg-white text-black text-[10px] font-black rounded-xl">PRINT PDF</button>
            </div>
        </main>
    </div>

    <div id="modal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[100]">
        <div class="bg-[#111] p-8 rounded-3xl w-80 border border-white/10">
            <h2 id="m-name" class="text-lg font-black uppercase mb-4"></h2>
            <select id="m-col" class="glass-input mb-3"></select>
            <select id="m-sz" class="glass-input mb-4"></select>
            <button onclick="Core.addItemToMemo()" class="w-full py-4 bg-amber-500 text-black font-black rounded-xl">ADD ITEM</button>
        </div>
    </div>

    <template id="memo-tpl">
        <div class="memo-card p-[12mm]" onclick="Core.selectMemo(this)">
            <div class="flex justify-between border-b-4 border-black pb-4 mb-6">
                <h1 class="text-5xl font-black italic italic leading-none">ONEN</h1>
                <div class="text-right"><div class="text-2xl font-black m-id">#000</div><div class="text-[10px] m-date"></div></div>
            </div>
            <div class="grid grid-cols-2 gap-8 mb-6">
                <div class="space-y-1">
                    <input class="m-name w-full border-none font-black text-xl p-0 focus:ring-0" placeholder="NAME">
                    <input class="m-phone w-full border-none font-bold text-md p-0 focus:ring-0" placeholder="PHONE">
                    <textarea class="m-addr w-full border-none text-[10px] h-12 p-0 resize-none focus:ring-0" placeholder="ADDRESS"></textarea>
                </div>
                <div class="text-right"><span class="m-ship-tag border-2 border-black px-3 py-1 text-[10px] font-black">INSIDE DHAKA</span></div>
            </div>
            <table class="w-full text-left text-[12px]">
                <thead class="border-b border-black font-black"><tr><th class="py-2">SL</th><th>ITEM</th><th class="text-center">VAR</th><th class="text-right">PRICE</th></tr></thead>
                <tbody class="m-body font-bold italic"></tbody>
            </table>
            <div class="mt-auto border-t border-slate-100 pt-4 flex justify-between items-end">
                <p class="text-[8px] opacity-40 uppercase">7-Day Exchange Policy Applies</p>
                <div class="text-right font-black">
                    <div class="text-[10px] opacity-50">TOTAL DUE</div>
                    <div class="text-4xl m-total">0</div>
                </div>
            </div>
        </div>
    </template>

    <script>
        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDEENrU2aGMwdeTSSHzGhovpcZlmqiTuwM",
            authDomain: "onen-studio.firebaseapp.com",
            projectId: "onen-studio",
            databaseURL: "https://onen-studio-default-rtdb.firebaseio.com" // CRITICAL
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const Inventory = {
            data: [],
            init() {
                db.ref('inventory').on('value', (snap) => {
                    console.log("Cloud Data Received:", snap.val());
                    this.data = snap.val() ? Object.values(snap.val()) : [];
                    this.render();
                    document.getElementById('status-icon').classList.add('online');
                }, (error) => {
                    console.error("Cloud Error:", error);
                    alert("Sync Failed: Check your Firebase rules.");
                });
            },
            saveToCloud() {
                const sku = document.getElementById('in-sku').value.trim().toUpperCase();
                if(!sku) return alert("SKU required");
                
                const payload = {
                    sku,
                    name: document.getElementById('in-name').value,
                    price: parseFloat(document.getElementById('in-price').value) || 0,
                    cols: document.getElementById('in-cols').value.split(',').map(s => s.trim()),
                    sizes: document.getElementById('in-sizes').value.split(',').map(s => s.trim())
                };

                db.ref('inventory/' + sku).set(payload)
                    .then(() => { 
                        alert("Cloud Updated!"); 
                        ['in-sku','in-name','in-price','in-cols','in-sizes'].forEach(id => document.getElementById(id).value = '');
                    })
                    .catch(err => console.error("Write Error:", err));
            },
            render() {
                const search = document.getElementById('cat-search').value.toUpperCase();
                const filtered = this.data.filter(p => p.sku.includes(search) || p.name.toUpperCase().includes(search));
                
                document.getElementById('cat-list').innerHTML = filtered.map(p => `
                    <div onclick="Core.prepItem('${p.sku}')" class="bg-white/5 p-3 rounded-xl border border-white/5 cursor-pointer hover:border-amber-500">
                        <div class="text-[7px] text-amber-500 font-bold">${p.sku}</div>
                        <div class="text-[10px] font-black">${p.name}</div>
                    </div>`).join('');

                document.getElementById('inv-list-full').innerHTML = this.data.map(p => `
                    <div class="bg-white/5 p-3 rounded-xl flex justify-between items-center text-[10px]">
                        <div><b>${p.sku}</b> - ${p.name}</div>
                        <button onclick="db.ref('inventory/${p.sku}').remove()" class="text-red-500">DEL</button>
                    </div>`).join('');
            }
        };

        const Core = {
            activeIdx: 0, pending: null, seq: 101,
            init() { Inventory.init(); this.createNewMemo(); },
            createNewMemo() {
                const tpl = document.getElementById('memo-tpl').content.cloneNode(true);
                const card = tpl.querySelector('.memo-card');
                card.querySelector('.m-id').innerText = '#' + this.seq++;
                card.querySelector('.m-date').innerText = new Date().toLocaleDateString();
                document.getElementById('workspace').prepend(card);
                this.selectMemo(card);
            },
            selectMemo(el) {
                document.querySelectorAll('.memo-card').forEach(c => c.classList.remove('active'));
                el.classList.add('active');
                this.activeIdx = Array.from(document.querySelectorAll('.memo-card')).indexOf(el);
            },
            getActive() { return document.querySelectorAll('.memo-card')[this.activeIdx]; },
            processMagic() {
                const val = document.getElementById('magic-box').value;
                const phone = (val.match(/01[3-9]\d{8}/) || [""])[0];
                const lines = val.split('\n');
                const active = this.getActive();
                if(lines[0]) active.querySelector('.m-name').value = lines[0].toUpperCase();
                if(phone) active.querySelector('.m-phone').value = phone;
                active.querySelector('.m-addr').value = val.replace(phone, '').trim();
            },
            prepItem(sku) {
                this.pending = Inventory.data.find(i => i.sku === sku);
                document.getElementById('m-name').innerText = this.pending.name;
                document.getElementById('m-col').innerHTML = this.pending.cols.map(c => `<option>${c}</option>`).join('');
                document.getElementById('m-sz').innerHTML = this.pending.sizes.map(s => `<option>${s}</option>`).join('');
                document.getElementById('modal').style.display = 'flex';
            },
            addItemToMemo() {
                const row = `<tr>
                    <td class="py-2">1</td>
                    <td>${this.pending.name}</td>
                    <td class="text-center">${document.getElementById('m-col').value}/${document.getElementById('m-sz').value}</td>
                    <td class="text-right font-black">${this.pending.price}</td>
                </tr>`;
                this.getActive().querySelector('.m-body').insertAdjacentHTML('beforeend', row);
                this.recalc();
                document.getElementById('modal').style.display = 'none';
            },
            recalc() {
                let total = 0;
                this.getActive().querySelectorAll('.m-body tr').forEach(tr => {
                    total += parseFloat(tr.cells[3].innerText);
                });
                this.getActive().querySelector('.m-total').innerText = total;
            },
            exportExcel() {
                const data = Array.from(document.querySelectorAll('.memo-card')).map(m => ({
                    ID: m.querySelector('.m-id').innerText,
                    Name: m.querySelector('.m-name').value,
                    Phone: m.querySelector('.m-phone').value,
                    Total: m.querySelector('.m-total').innerText
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Orders");
                XLSX.writeFile(wb, "Onen_Orders.xlsx");
            },
            exportPDF() {
                html2pdf().from(document.getElementById('workspace')).save();
            }
        };

        const UI = {
            toggleView() {
                document.getElementById('ops-view').classList.toggle('hidden-view');
                document.getElementById('inv-view').classList.toggle('hidden-view');
            }
        };

        window.onload = () => Core.init();
    </script>
</body>
</html>
