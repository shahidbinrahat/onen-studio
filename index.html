<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONEN STUDIO | Logistics Engine</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root { 
            --accent: #F59E0B; 
            --apple-curve: cubic-bezier(0.4, 0, 0.2, 1);
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #000; 
            color: white; 
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        .glass { 
            background: rgba(255,255,255,0.02); 
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.08); 
            border-radius: 14px; 
            transition: all 0.3s var(--apple-curve); 
        }

        .memo-card { 
            width: 210mm; height: 148.5mm; background: white; color: black; 
            margin: 0 auto 100px auto; display: flex; flex-direction: column; padding: 12mm 14mm;
            position: relative; transition: all 0.6s var(--apple-curve); 
            transform: scale(0.95); opacity: 0.2;
            box-sizing: border-box; overflow: hidden; border-radius: 8px;
            filter: blur(4px);
        }

        .memo-card.active { 
            transform: scale(1); opacity: 1; filter: blur(0);
            box-shadow: 0 40px 80px -15px rgba(0,0,0,0.8); 
        }

        .pill-btn {
            padding: 8px 16px;
            font-size: 9px;
            font-weight: 900;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 99px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .pill-btn.active-state { background: white; color: black; border-color: white; }
        
        /* Status Colors */
        .st-pending { color: #64748b; border-color: #cbd5e1; }
        .st-unpaid { color: #d97706; border-color: #fcd34d; }
        .st-paid { color: #059669; border-color: #6ee7b7; }
        .st-exchange { color: #7c3aed; border-color: #c4b5fd; }
        .st-returned { color: #dc2626; border-color: #fca5a5; }

        .type-pill { background: #000; color: #fff; padding: 4px 12px; font-size: 10px; font-weight: 900; }
        .type-pill.exchange { background: #F59E0B; color: #000; }

        .row-remove-btn { 
            opacity: 0; 
            transition: opacity 0.2s; 
            color: #ef4444; 
            cursor: pointer;
            padding: 4px;
        }
        tr:hover .row-remove-btn { opacity: 1; }

        .custom-scroll::-webkit-scrollbar { width: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        @media print { 
            .no-print { display: none !important; } 
            body { background: white; height: auto; overflow: visible; }
            .memo-card { opacity: 1!important; transform: scale(1)!important; margin: 0!important; box-shadow: none!important; page-break-after: always; filter: none!important; display: flex !important; } 
        }
    </style>
</head>
<body>

    <div class="flex h-screen overflow-hidden no-print">
        <!-- Sidebar Navigation -->
        <aside class="w-80 bg-[#050505] border-r border-white/5 p-8 flex flex-col gap-8 custom-scroll overflow-y-auto">
            <div class="text-amber-500 font-black italic text-3xl mb-4 tracking-tighter">ONEN STUDIO.</div>
            
            <button id="btn-new-memo" class="w-full bg-white text-black py-4 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-amber-500 transition-all">Create New Memo</button>

            <!-- Order Status Logic -->
            <div class="space-y-4">
                <label class="text-[9px] uppercase font-black opacity-30 tracking-[0.3em]">Lifecycle Status</label>
                <div class="flex flex-wrap gap-2" id="status-toggles">
                    <button data-action="setLifecycle" data-state="PENDING" class="pill-btn active-state">Pending</button>
                    <button data-action="setLifecycle" data-state="UNPAID" class="pill-btn">Unpaid</button>
                    <button data-action="setLifecycle" data-state="PAID" class="pill-btn">Paid</button>
                    <button data-action="setLifecycle" data-state="EXCHANGE" class="pill-btn">Exchange</button>
                    <button data-action="setLifecycle" data-state="RETURNED" class="pill-btn">Returned</button>
                </div>
            </div>

            <!-- Parcel Type Logic -->
            <div class="space-y-4">
                <label class="text-[9px] uppercase font-black opacity-30 tracking-[0.3em]">Parcel Type</label>
                <div class="flex gap-2">
                    <button data-action="setType" data-type="REGULAR" class="pill-btn flex-1 active-state">Regular</button>
                    <button data-action="setType" data-type="EXCHANGE" class="pill-btn flex-1">Exchange</button>
                </div>
            </div>

            <!-- Shipping Tiers -->
            <div class="space-y-4">
                <label class="text-[9px] uppercase font-black opacity-30 tracking-[0.3em]">Shipping Zone</label>
                <div class="grid grid-cols-2 gap-2">
                    <button data-action="setShip" data-val="60" data-tag="DHAKA" class="pill-btn">Dhaka (60)</button>
                    <button data-action="setShip" data-val="100" data-tag="SUB-URBAN" class="pill-btn">Suburban (100)</button>
                    <button data-action="setShip" data-val="120" data-tag="OUTSIDE" class="pill-btn col-span-2">Outside Dhaka (120)</button>
                </div>
            </div>

            <div class="border-t border-white/5 pt-6">
                <label class="text-[9px] uppercase font-black opacity-30 tracking-[0.3em] mb-4 block">Bulk Actions</label>
                <div class="grid grid-cols-1 gap-2">
                    <button data-action="export" data-provider="steadfast" class="glass p-3 text-[9px] font-bold text-left hover:border-amber-500 flex justify-between items-center">
                        Steadfast Export <i class="fa-solid fa-file-csv opacity-30"></i>
                    </button>
                    <button data-action="export" data-provider="pathao" class="glass p-3 text-[9px] font-bold text-left hover:border-amber-500 flex justify-between items-center">
                        Pathao Export <i class="fa-solid fa-file-csv opacity-30"></i>
                    </button>
                </div>
            </div>

            <div class="mt-auto pt-6 border-t border-white/5">
                <label class="text-[9px] uppercase font-black opacity-30 tracking-[0.3em] mb-4 block">History</label>
                <div id="history-list" class="space-y-2"></div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-grow bg-[#0a0a0a] overflow-y-auto p-12 relative no-scrollbar">
            <div id="workspace" class="max-w-4xl mx-auto pb-48"></div>

            <!-- Bottom Floating Bar -->
            <div class="fixed bottom-10 left-1/2 -translate-x-1/2 flex items-center gap-6 bg-white/5 backdrop-blur-3xl px-8 py-4 rounded-3xl border border-white/10 shadow-2xl z-50">
                <textarea id="quick-parse" class="bg-transparent border-none text-[10px] w-64 h-10 resize-none outline-none placeholder:opacity-20" placeholder="Paste order details to auto-fill..."></textarea>
                <div class="h-8 w-px bg-white/10"></div>
                <button id="btn-open-picker" class="text-[10px] font-black uppercase tracking-widest px-4 hover:text-amber-500 transition-all">Add Item</button>
                <button onclick="window.print()" class="bg-white text-black px-10 py-3 rounded-xl text-[10px] font-black uppercase hover:scale-105 transition-all">Print Active</button>
            </div>
        </main>
    </div>

    <!-- Product Picker -->
    <div id="picker-modal" class="fixed inset-0 bg-black/90 backdrop-blur-xl hidden items-center justify-center z-[100] p-10 no-print">
        <div class="bg-[#111] border border-white/10 p-12 rounded-[2rem] w-full max-w-4xl max-h-[80vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-10">
                <h3 class="text-3xl font-black uppercase tracking-tighter text-white">Inventory Picker</h3>
                <button id="btn-close-picker" class="opacity-30 hover:opacity-100 text-white text-2xl">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 overflow-y-auto custom-scroll pr-4" id="picker-grid"></div>
        </div>
    </div>

    <!-- MEMO TEMPLATE -->
    <template id="memo-tpl">
        <div class="memo-card">
            <div class="flex justify-between border-b-[6px] border-black pb-4 mb-8">
                <div>
                    <h1 class="text-6xl font-black italic tracking-tighter">ONEN</h1>
                    <div class="flex gap-2 items-center mt-2">
                        <span class="m-status-tag font-black text-[9px] uppercase px-3 py-1 border-[2px] rounded-full">PENDING</span>
                        <span class="m-type-tag font-black text-[9px] uppercase px-3 py-1 bg-black text-white rounded-full">REGULAR</span>
                    </div>
                </div>
                <div class="text-right flex flex-col justify-end">
                    <div class="text-4xl font-black m-id tracking-tighter">#0000</div>
                    <div class="text-[9px] font-black opacity-40 m-date uppercase tracking-widest mt-1"></div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-12 mb-6">
                <div class="space-y-2">
                    <input class="m-name w-full border-none font-black text-2xl p-0 focus:ring-0 uppercase bg-transparent text-black" placeholder="RECIPIENT NAME">
                    <input class="m-phone w-full border-none font-bold text-xl p-0 focus:ring-0 bg-transparent text-black" placeholder="PHONE NUMBER">
                    <textarea class="m-addr w-full border-none text-[12px] h-12 p-0 focus:ring-0 resize-none font-medium bg-transparent text-black" placeholder="SHIPPING ADDRESS"></textarea>
                </div>
                <div class="text-right">
                    <span class="m-tag border-[3px] border-black px-6 py-2 text-[11px] font-black italic tracking-widest inline-block">DHAKA</span>
                </div>
            </div>

            <div class="flex-grow overflow-hidden">
                <table class="w-full text-[13px]">
                    <thead class="border-b-2 border-black font-black text-[9px] uppercase text-left">
                        <tr>
                            <th class="pb-3 w-8">#</th>
                            <th class="pb-3">DESCRIPTION</th>
                            <th class="pb-3 text-center">VARIANT</th>
                            <th class="pb-3 text-center w-12">QTY</th>
                            <th class="pb-3 text-right w-24">PRICE</th>
                            <th class="pb-3 w-8 no-print"></th>
                        </tr>
                    </thead>
                    <tbody class="m-rows font-bold"></tbody>
                </table>
            </div>

            <div class="mt-4 pt-4 border-t border-black/5">
                <label class="text-[8px] font-black uppercase opacity-40 tracking-widest mb-1 block">Special Instructions</label>
                <textarea class="m-instructions w-full border-none text-[10px] p-0 focus:ring-0 resize-none font-bold bg-transparent h-10 text-black" placeholder="E.g. Call before delivery..."></textarea>
            </div>

            <div class="mt-4 border-t-2 border-black pt-6 flex justify-between items-end">
                <div class="text-[8px] font-bold opacity-40 leading-relaxed uppercase">
                    <p>7-Day Exchange window valid from delivery date</p>
                    <p>Items must be in original condition with all tags intact</p>
                    <p class="mt-2 text-black opacity-100">THANK YOU FOR SHOPPING AT ONEN STUDIO</p>
                </div>
                <div class="text-right w-64">
                    <div class="flex justify-between text-[11px] font-bold mb-2">
                        <span class="opacity-40 uppercase">Delivery Charge</span>
                        <span class="m-ship-val tracking-tight">0</span>
                    </div>
                    <div class="flex justify-between border-t-[3px] border-black pt-3 font-black">
                        <span class="text-[12px] mt-2 uppercase italic">Grand Total</span>
                        <div class="flex items-start">
                            <span class="text-xl mt-1 mr-1">৳</span>
                            <span class="text-5xl m-total tracking-tighter">0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <button class="m-delete-btn no-print absolute top-4 right-4 text-slate-300 hover:text-red-500 transition-colors"><i class="fa-solid fa-trash-can"></i></button>
        </div>
    </template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'onen-studio-v2';

        let user = null;
        let memos = [];
        let activeIdx = 0;

        const Inventory = [
            { id: 1, name: "Onyx Basic Tee", price: 1250, variants: ["Black/M", "Black/L", "Black/XL"] },
            { id: 2, name: "Ghost Cargo Pants", price: 2850, variants: ["Grey/30", "Grey/32", "Grey/34"] },
            { id: 3, name: "Neon Studio Hoodie", price: 3400, variants: ["Purple/L", "Purple/XL"] },
            { id: 4, name: "Gravity Oversized", price: 1650, variants: ["Cream/M", "Cream/L"] },
            { id: 5, name: "Studio Tote Bag", price: 650, variants: ["Black/OneSize"] },
            { id: 6, name: "Cyber Socks", price: 350, variants: ["White", "Black"] }
        ];

        const Core = {
            async init() {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) this.setupListener();
                });
                this.bindEvents();
            },

            setupListener() {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'memos'));
                onSnapshot(q, (snap) => {
                    const data = [];
                    snap.forEach(doc => data.push({ ...doc.data(), docId: doc.id }));
                    memos = data.sort((a, b) => b.createdAt - a.createdAt);
                    this.renderWorkspace();
                }, (err) => {
                    console.error("Firestore error:", err);
                });
            },

            bindEvents() {
                document.getElementById('btn-new-memo').onclick = () => this.createNewMemo();
                document.getElementById('btn-open-picker').onclick = () => this.openPicker();
                document.getElementById('btn-close-picker').onclick = () => this.closePicker();
                document.getElementById('quick-parse').oninput = (e) => this.parse(e.target.value);

                document.querySelectorAll('[data-action]').forEach(btn => {
                    btn.onclick = (e) => {
                        const action = btn.dataset.action;
                        if (action === 'setLifecycle') this.updateMemo({ status: btn.dataset.state });
                        if (action === 'setType') this.updateMemo({ type: btn.dataset.type });
                        if (action === 'setShip') this.updateMemo({ ship: parseInt(btn.dataset.val), tag: btn.dataset.tag });
                        if (action === 'export') this.exportData(btn.dataset.provider);
                    };
                });
            },

            async createNewMemo() {
                if (!user) return;
                const newId = '#' + Math.floor(1000 + Math.random() * 9000);
                const docId = crypto.randomUUID();
                const memo = {
                    id: newId,
                    date: new Date().toLocaleDateString('en-GB'),
                    name: '',
                    phone: '',
                    addr: '',
                    instructions: '',
                    ship: 60,
                    tag: 'DHAKA',
                    status: 'PENDING',
                    type: 'REGULAR',
                    items: [],
                    createdAt: Date.now()
                };
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'memos', docId), memo);
                activeIdx = 0; 
            },

            renderWorkspace() {
                const workspace = document.getElementById('workspace');
                const historyList = document.getElementById('history-list');
                workspace.innerHTML = '';
                historyList.innerHTML = '';

                if (memos.length === 0) {
                    workspace.innerHTML = `<div class="text-center py-20 opacity-20 font-black uppercase tracking-widest">No Memos. Creating New...</div>`;
                    this.createNewMemo();
                    return;
                }

                memos.forEach((m, i) => {
                    const tpl = document.getElementById('memo-tpl').content.cloneNode(true);
                    const card = tpl.querySelector('.memo-card');
                    
                    if (i === activeIdx) card.classList.add('active');
                    
                    card.querySelector('.m-id').innerText = m.id;
                    card.querySelector('.m-date').innerText = m.date;
                    
                    // Controlled Inputs with debounced update (handled by onchange)
                    const bindInput = (selector, key) => {
                        const el = card.querySelector(selector);
                        el.value = m[key] || '';
                        el.onchange = (e) => this.updateMemo({ [key]: e.target.value }, m.docId);
                    };

                    bindInput('.m-name', 'name');
                    bindInput('.m-phone', 'phone');
                    bindInput('.m-addr', 'addr');
                    bindInput('.m-instructions', 'instructions');

                    card.querySelector('.m-tag').innerText = m.tag;
                    card.querySelector('.m-ship-val').innerText = m.ship;

                    const sTag = card.querySelector('.m-status-tag');
                    sTag.innerText = m.status;
                    sTag.className = `m-status-tag font-black text-[9px] uppercase px-3 py-1 border-[2px] rounded-full st-${m.status.toLowerCase()}`;

                    const tTag = card.querySelector('.m-type-tag');
                    tTag.innerText = m.type;
                    tTag.className = `m-type-tag font-black text-[9px] uppercase px-3 py-1 rounded-full ${m.type === 'EXCHANGE' ? 'exchange' : ''} type-pill`;

                    const rows = card.querySelector('.m-rows');
                    let subtotal = 0;
                    
                    m.items.forEach((item, idx) => {
                        const itemTotal = (item.price * item.qty);
                        subtotal += itemTotal;
                        const tr = document.createElement('tr');
                        tr.className = "border-b border-black/5 group";
                        tr.innerHTML = `
                            <td class="py-3 opacity-20">${idx + 1}</td>
                            <td class="py-3 uppercase">${item.name}</td>
                            <td class="text-center">${item.variant}</td>
                            <td class="text-center font-black">
                                <div class="flex items-center justify-center gap-2 no-print">
                                    <button class="qty-sub opacity-30 hover:opacity-100 px-1 text-lg">×</button>
                                    <span>${item.qty}</span>
                                    <button class="qty-add opacity-30 hover:opacity-100 px-1 text-lg">+</button>
                                </div>
                                <span class="hidden print:inline">${item.qty}</span>
                            </td>
                            <td class="text-right">${itemTotal.toLocaleString()}</td>
                            <td class="no-print text-right pl-2">
                                <span class="row-remove-btn"><i class="fa-solid fa-xmark"></i></span>
                            </td>
                        `;
                        
                        tr.querySelector('.qty-add').onclick = () => {
                            const newItems = [...m.items];
                            newItems[idx].qty++;
                            this.updateMemo({ items: newItems }, m.docId);
                        };
                        tr.querySelector('.qty-sub').onclick = () => {
                            const newItems = [...m.items];
                            if (newItems[idx].qty > 1) {
                                newItems[idx].qty--;
                                this.updateMemo({ items: newItems }, m.docId);
                            }
                        };
                        tr.querySelector('.row-remove-btn').onclick = () => {
                            const newItems = [...m.items];
                            newItems.splice(idx, 1);
                            this.updateMemo({ items: newItems }, m.docId);
                        };
                        rows.appendChild(tr);
                    });

                    card.querySelector('.m-total').innerText = (subtotal + m.ship).toLocaleString();

                    card.onclick = () => {
                        if (activeIdx !== i) {
                            activeIdx = i;
                            this.renderWorkspace();
                        }
                    };

                    card.querySelector('.m-delete-btn').onclick = (e) => {
                        e.stopPropagation();
                        this.deleteMemo(m.docId);
                    };

                    workspace.appendChild(card);

                    // History Item Sidebar
                    const hist = document.createElement('div');
                    hist.className = `p-4 glass cursor-pointer transition-all ${i === activeIdx ? 'border-amber-500 bg-white/5 opacity-100' : 'opacity-40 hover:opacity-100'}`;
                    hist.innerHTML = `
                        <div class="text-[10px] font-black uppercase truncate text-white">${m.name || 'UNNAMED ORDER'}</div>
                        <div class="flex justify-between mt-1 opacity-60 text-[8px] font-black">
                            <span>${m.id}</span>
                            <span>${(subtotal + m.ship).toLocaleString()}৳</span>
                        </div>
                    `;
                    hist.onclick = () => {
                        activeIdx = i;
                        this.renderWorkspace();
                    };
                    historyList.appendChild(hist);
                });

                this.updateSidebarButtons();
            },

            updateSidebarButtons() {
                const m = memos[activeIdx];
                if (!m) return;
                
                document.querySelectorAll('#status-toggles .pill-btn').forEach(btn => {
                    btn.classList.toggle('active-state', btn.dataset.state === m.status);
                });
                document.querySelectorAll('[data-type]').forEach(btn => {
                    btn.classList.toggle('active-state', btn.dataset.type === m.type);
                });
                document.querySelectorAll('[data-val]').forEach(btn => {
                    btn.classList.toggle('active-state', parseInt(btn.dataset.val) === m.ship);
                });
            },

            async updateMemo(data, specificId = null) {
                if (!user) return;
                const id = specificId || memos[activeIdx]?.docId;
                if (!id) return;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'memos', id), data);
            },

            async deleteMemo(id) {
                if (!user) return;
                if (!confirm("Permanently delete this memo?")) return;
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'memos', id));
                if (activeIdx >= memos.length - 1) activeIdx = Math.max(0, memos.length - 2);
            },

            openPicker() {
                const modal = document.getElementById('picker-modal');
                const grid = document.getElementById('picker-grid');
                modal.classList.replace('hidden', 'flex');
                
                grid.innerHTML = Inventory.map(item => `
                    <div class="glass p-8 flex flex-col gap-4 border-white/5 hover:border-amber-500/30">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-black uppercase text-xl text-white tracking-tighter">${item.name}</h4>
                                <span class="text-amber-500 font-bold text-xs">৳${item.price.toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${item.variants.map(v => `
                                <button class="pill-btn hover:bg-white hover:text-black text-white border-white/10 add-item-trigger" 
                                    data-name="${item.name}" data-var="${v}" data-price="${item.price}">
                                    ${v}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `).join('');

                grid.querySelectorAll('.add-item-trigger').forEach(btn => {
                    btn.onclick = () => {
                        const m = memos[activeIdx];
                        const newItem = {
                            name: btn.dataset.name,
                            variant: btn.dataset.var,
                            price: parseInt(btn.dataset.price),
                            qty: 1
                        };
                        this.updateMemo({ items: [...m.items, newItem] });
                        this.closePicker();
                    };
                });
            },

            closePicker() {
                document.getElementById('picker-modal').classList.replace('flex', 'hidden');
            },

            parse(val) {
                if (!val) return;
                
                const phoneMatch = val.match(/01[3-9]\d{8}/);
                const phone = phoneMatch ? phoneMatch[0] : "";
                
                const lines = val.split('\n').map(l => l.trim()).filter(l => l);
                if (lines.length < 1) return;

                const name = lines[0].toUpperCase();
                // Filter out the phone and name to get remaining text as address
                const addr = val.replace(lines[0], '').replace(phone, '').replace(/\n/g, ' ').trim();
                
                this.updateMemo({ name, phone, addr });
                
                // UX: Clear after success feedback
                setTimeout(() => {
                    if (document.getElementById('quick-parse').value === val) {
                        document.getElementById('quick-parse').value = '';
                    }
                }, 1500);
            },

            exportData(provider) {
                if (memos.length === 0) return;
                
                const headers = provider === 'steadfast' 
                    ? ["Invoice","Name","Contact","Address","Amount","Note"]
                    : ["Store","OrderID","RecipientName","RecipientPhone","RecipientAddress","City","Amount","Note"];
                
                const rows = memos.map(m => {
                    const subtotal = m.items.reduce((acc, curr) => acc + (curr.price * curr.qty), 0);
                    const total = subtotal + m.ship;
                    const cleanAddr = (m.addr || '').replace(/,/g, ' ').replace(/"/g, "'");
                    const cleanNote = `${m.type} | ${m.instructions || ''}`.replace(/,/g, ' ').replace(/"/g, "'");

                    if (provider === 'steadfast') {
                        return [m.id, m.name, m.phone, cleanAddr, total, cleanNote];
                    } else {
                        return ["ONEN STUDIO", m.id, m.name, m.phone, cleanAddr, m.tag, total, m.instructions];
                    }
                });

                const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ONEN_STUDIO_${provider.toUpperCase()}_${new Date().toLocaleDateString().replace(/\//g,'-')}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        };

        Core.init();
    </script>
</body>
</html>
