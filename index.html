<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONEN STUDIO | Logistics Engine</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root { 
            --accent: #F59E0B; 
            --apple-curve: cubic-bezier(0.4, 0, 0.2, 1);
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #000; 
            color: white; 
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        .glass { 
            background: rgba(255,255,255,0.02); 
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.08); 
            border-radius: 14px; 
            transition: all 0.3s var(--apple-curve); 
        }

        .memo-card { 
            width: 210mm; 
            min-height: 148.5mm; 
            background: white; 
            color: black; 
            margin: 0 auto 100px auto; 
            display: flex; 
            flex-direction: column; 
            padding: 12mm 14mm;
            position: relative; 
            transition: all 0.4s var(--apple-curve); 
            transform: scale(0.98); 
            opacity: 0.3;
            box-sizing: border-box; 
            border-radius: 8px;
            filter: blur(2px);
        }

        .memo-card.active { 
            transform: scale(1); opacity: 1; filter: blur(0);
            box-shadow: 0 40px 80px -15px rgba(0,0,0,0.8); 
        }

        .pill-btn {
            padding: 8px 16px;
            font-size: 9px;
            font-weight: 900;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 99px;
            transition: all 0.2s;
            cursor: pointer;
            color: rgba(255,255,255,0.4);
        }
        .pill-btn:hover { border-color: rgba(255,255,255,0.3); color: white; }
        .pill-btn.active-state { background: white; color: black; border-color: white; }
        
        .st-pending { color: #64748b; border-color: #64748b; }
        .st-unpaid { color: #d97706; border-color: #d97706; }
        .st-paid { color: #059669; border-color: #059669; }
        .st-exchange { color: #7c3aed; border-color: #7c3aed; }
        .st-returned { color: #dc2626; border-color: #dc2626; }

        .row-remove-btn { 
            opacity: 0; 
            transition: opacity 0.2s; 
            color: #ef4444; 
            cursor: pointer;
            padding: 4px;
        }
        tr:hover .row-remove-btn { opacity: 1; }

        .custom-scroll::-webkit-scrollbar { width: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        #sync-indicator.online { color: #10b981; }
        #sync-indicator.offline { color: #ef4444; }
        #sync-indicator.syncing { color: #f59e0b; animation: pulse 2s infinite; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @media print { 
            .no-print { display: none !important; } 
            body { background: white; height: auto; overflow: visible; }
            .memo-card { 
                opacity: 1!important; 
                transform: scale(1)!important; 
                margin: 0 auto 0 auto !important; 
                box-shadow: none!important; 
                page-break-after: always; 
                filter: none!important; 
                display: flex !important;
                border: none;
            } 
        }

        #debug-console {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            color: #0f0;
            font-family: monospace;
            font-size: 8px;
            padding: 10px;
            border-radius: 5px;
            z-index: 9999;
            max-width: 200px;
            pointer-events: none;
            display: none;
        }
    </style>
</head>
<body>

    <div id="debug-console"></div>

    <div class="flex h-screen overflow-hidden no-print">
        <!-- Sidebar -->
        <aside class="w-80 bg-[#050505] border-r border-white/5 p-8 flex flex-col gap-8 custom-scroll overflow-y-auto">
            <div class="flex justify-between items-start">
                <div class="text-amber-500 font-black italic text-3xl tracking-tighter">ONEN STUDIO.</div>
                <div id="sync-indicator" class="text-[10px] flex items-center gap-1.5 font-bold syncing mt-2 cursor-pointer">
                    <i class="fa-solid fa-circle text-[6px]"></i> <span>Initializing...</span>
                </div>
            </div>
            
            <button id="btn-new-memo" class="w-full bg-white text-black py-4 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-amber-500 transition-all flex items-center justify-center gap-2">
                <i class="fa-solid fa-plus"></i> Create New Memo
            </button>

            <div class="space-y-4">
                <label class="text-[9px] uppercase font-black opacity-30 tracking-[0.3em]">Lifecycle Status</label>
                <div class="flex flex-wrap gap-2" id="status-toggles">
                    <button data-action="setLifecycle" data-state="PENDING" class="pill-btn">Pending</button>
                    <button data-action="setLifecycle" data-state="UNPAID" class="pill-btn">Unpaid</button>
                    <button data-action="setLifecycle" data-state="PAID" class="pill-btn">Paid</button>
                    <button data-action="setLifecycle" data-state="EXCHANGE" class="pill-btn">Exchange</button>
                    <button data-action="setLifecycle" data-state="RETURNED" class="pill-btn">Returned</button>
                </div>
            </div>

            <div class="space-y-4">
                <label class="text-[9px] uppercase font-black opacity-30 tracking-[0.3em]">Parcel Type</label>
                <div class="flex gap-2">
                    <button data-action="setType" data-type="REGULAR" class="pill-btn flex-1">Regular</button>
                    <button data-action="setType" data-type="EXCHANGE" class="pill-btn flex-1">Exchange</button>
                </div>
            </div>

            <div class="space-y-4">
                <label class="text-[9px] uppercase font-black opacity-30 tracking-[0.3em]">Shipping Zone</label>
                <div class="grid grid-cols-2 gap-2" id="shipping-toggles">
                    <button data-action="setShip" data-val="60" data-tag="DHAKA" class="pill-btn">Dhaka (60)</button>
                    <button data-action="setShip" data-val="100" data-tag="SUB-URBAN" class="pill-btn">Suburban (100)</button>
                    <button data-action="setShip" data-val="120" data-tag="OUTSIDE" class="pill-btn col-span-2">Outside (120)</button>
                </div>
            </div>

            <div class="border-t border-white/5 pt-6">
                <label class="text-[9px] uppercase font-black opacity-30 tracking-[0.3em] mb-4 block">Logistics Export</label>
                <div class="grid grid-cols-1 gap-2">
                    <button id="btn-export-steadfast" class="glass p-3 text-[9px] font-bold text-left hover:border-amber-500 flex justify-between items-center group">
                        Steadfast CSV <i class="fa-solid fa-file-csv opacity-30 group-hover:opacity-100 group-hover:text-amber-500"></i>
                    </button>
                    <button id="btn-export-pathao" class="glass p-3 text-[9px] font-bold text-left hover:border-amber-500 flex justify-between items-center group">
                        Pathao CSV <i class="fa-solid fa-file-csv opacity-30 group-hover:opacity-100 group-hover:text-amber-500"></i>
                    </button>
                    <button id="btn-export-carrybee" class="glass p-3 text-[9px] font-bold text-left hover:border-amber-500 flex justify-between items-center group">
                        Carrybee CSV <i class="fa-solid fa-truck-fast opacity-30 group-hover:opacity-100 group-hover:text-amber-500"></i>
                    </button>
                </div>
            </div>

            <div class="mt-auto pt-6 border-t border-white/5">
                <label class="text-[9px] uppercase font-black opacity-30 tracking-[0.3em] mb-4 block">Recent History</label>
                <div id="history-list" class="space-y-2 max-h-48 overflow-y-auto custom-scroll pr-2"></div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-grow bg-[#0a0a0a] overflow-y-auto p-12 relative no-scrollbar">
            <div id="workspace" class="max-w-4xl mx-auto pb-48">
                <!-- Loading State UI -->
                <div id="initial-loader" class="flex flex-col items-center justify-center h-[60vh] text-white/20">
                    <div class="w-12 h-12 border-2 border-amber-500/20 border-t-amber-500 rounded-full animate-spin mb-4"></div>
                    <p class="text-[10px] font-black uppercase tracking-[0.5em]">Establishing Sync Connection</p>
                </div>
            </div>

            <!-- Contextual Controls -->
            <div class="fixed bottom-10 left-1/2 -translate-x-1/2 flex items-center gap-6 bg-white/5 backdrop-blur-3xl px-8 py-4 rounded-3xl border border-white/10 shadow-2xl z-50">
                <div class="flex flex-col">
                    <label class="text-[8px] font-black uppercase opacity-20 tracking-tighter mb-1">Quick Auto-Fill</label>
                    <textarea id="quick-parse" class="bg-transparent border-none text-[10px] w-64 h-8 resize-none outline-none placeholder:opacity-20 text-white" placeholder="Paste order details here..."></textarea>
                </div>
                <div class="h-8 w-px bg-white/10"></div>
                <button id="btn-open-picker" class="text-[10px] font-black uppercase tracking-widest px-4 hover:text-amber-500 transition-all flex items-center gap-2">
                    <i class="fa-solid fa-cart-plus"></i> Add Product
                </button>
                <button onclick="window.print()" class="bg-white text-black px-10 py-3 rounded-xl text-[10px] font-black uppercase hover:scale-105 transition-all active:scale-95 shadow-lg">Print Current</button>
            </div>
        </main>
    </div>

    <!-- Modals (Picker & Inventory) remain same structure -->
    <div id="picker-modal" class="fixed inset-0 bg-black/95 backdrop-blur-xl hidden items-center justify-center z-[100] p-10 no-print">
        <div class="bg-[#111] border border-white/10 p-12 rounded-[2rem] w-full max-w-4xl max-h-[80vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-10">
                <div class="flex items-center gap-6">
                    <div>
                        <h3 class="text-3xl font-black uppercase tracking-tighter text-white">Select Product</h3>
                        <p class="text-[10px] opacity-40 font-bold uppercase tracking-widest mt-1">Select Size & Color to Add</p>
                    </div>
                    <button id="btn-manage-inventory-cog" class="w-10 h-10 rounded-full border border-white/10 flex items-center justify-center text-white/40 hover:text-amber-500 hover:border-amber-500/50 transition-all">
                        <i class="fa-solid fa-cog"></i>
                    </button>
                </div>
                <button id="btn-close-picker" class="opacity-30 hover:opacity-100 text-white text-4xl">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 overflow-y-auto custom-scroll pr-4 pb-4" id="picker-grid"></div>
        </div>
    </div>

    <div id="inventory-modal" class="fixed inset-0 bg-black/98 backdrop-blur-2xl hidden items-center justify-center z-[120] p-10 no-print">
        <div class="bg-[#050505] border border-white/10 p-12 rounded-[2rem] w-full max-w-5xl h-[85vh] flex flex-col">
            <div class="flex justify-between items-start mb-12">
                <div>
                    <h2 class="text-4xl font-black italic tracking-tighter text-amber-500">INVENTORY MANAGER</h2>
                    <p class="text-[10px] font-bold opacity-40 uppercase tracking-[0.4em] mt-2">Manage Your Product Catalog</p>
                </div>
                <button id="btn-close-inventory" class="text-white opacity-20 hover:opacity-100 text-5xl">&times;</button>
            </div>
            <div class="grid grid-cols-4 gap-8 mb-8">
                <input id="inv-name" class="bg-white/5 border border-white/10 p-4 rounded-xl w-full text-xs font-bold outline-none focus:border-amber-500 text-white" placeholder="Product Name">
                <input id="inv-price" type="number" class="bg-white/5 border border-white/10 p-4 rounded-xl w-full text-xs font-bold outline-none focus:border-amber-500 text-white" placeholder="Price">
                <input id="inv-vars" class="bg-white/5 border border-white/10 p-4 rounded-xl w-full text-xs font-bold outline-none focus:border-amber-500 text-white" placeholder="Sizes (e.g. S, M, L)">
                <input id="inv-colors" class="bg-white/5 border border-white/10 p-4 rounded-xl w-full text-xs font-bold outline-none focus:border-amber-500 text-white" placeholder="Colors (e.g. Black, White)">
                <button id="btn-save-inv" class="bg-amber-500 text-black font-black uppercase text-[10px] tracking-widest py-4 rounded-xl col-span-4 hover:scale-[1.01] transition-all">Save to Catalog</button>
            </div>
            <div class="flex-grow overflow-y-auto custom-scroll pr-4">
                <table class="w-full text-left text-[11px]">
                    <thead class="border-b border-white/10 uppercase font-black opacity-30">
                        <tr><th class="pb-4">Product</th><th class="pb-4">Price</th><th class="pb-4">Sizes</th><th class="pb-4">Colors</th><th class="pb-4 text-right">Actions</th></tr>
                    </thead>
                    <tbody id="inv-table-body" class="font-bold"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Memo Template -->
    <template id="memo-tpl">
        <div class="memo-card">
            <div class="flex justify-between border-b-[6px] border-black pb-4 mb-8">
                <div>
                    <h1 class="text-6xl font-black italic tracking-tighter">ONEN</h1>
                    <div class="flex gap-2 items-center mt-2">
                        <span class="m-status-tag font-black text-[9px] uppercase px-3 py-1 border-[2px] rounded-full">PENDING</span>
                        <span class="m-type-tag font-black text-[9px] uppercase px-3 py-1 bg-black text-white rounded-full">REGULAR</span>
                    </div>
                </div>
                <div class="text-right flex flex-col justify-end">
                    <div class="text-4xl font-black m-id tracking-tighter">#0000</div>
                    <div class="text-[9px] font-black opacity-40 m-date uppercase tracking-widest mt-1"></div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-12 mb-6">
                <div class="space-y-2">
                    <input class="m-name w-full border-none font-black text-2xl p-0 focus:ring-0 uppercase bg-transparent text-black" placeholder="RECIPIENT NAME">
                    <input class="m-phone w-full border-none font-bold text-xl p-0 focus:ring-0 bg-transparent text-black" placeholder="PHONE NUMBER">
                    <textarea class="m-addr w-full border-none text-[12px] h-12 p-0 focus:ring-0 resize-none font-medium bg-transparent text-black" placeholder="SHIPPING ADDRESS"></textarea>
                </div>
                <div class="text-right">
                    <span class="m-tag border-[3px] border-black px-6 py-2 text-[11px] font-black italic tracking-widest inline-block uppercase">DHAKA</span>
                </div>
            </div>
            <div class="flex-grow">
                <table class="w-full text-[13px]">
                    <thead class="border-b-2 border-black font-black text-[9px] uppercase text-left">
                        <tr>
                            <th class="pb-3 w-8">#</th><th class="pb-3">DESCRIPTION</th><th class="pb-3 text-center">SIZE</th><th class="pb-3 text-center">COLOR</th><th class="pb-3 text-center w-12">QTY</th><th class="pb-3 text-right w-24">PRICE</th><th class="pb-3 w-8 no-print"></th>
                        </tr>
                    </thead>
                    <tbody class="m-rows font-bold"></tbody>
                </table>
            </div>
            <div class="mt-6 pt-4 border-t border-black/5">
                <textarea class="m-instructions w-full border-none text-[10px] p-0 focus:ring-0 resize-none font-bold bg-transparent h-10 text-black" placeholder="SPECIAL INSTRUCTIONS..."></textarea>
            </div>
            <div class="mt-4 border-t-2 border-black pt-6 flex justify-between items-end">
                <div class="text-[8px] font-bold opacity-40 leading-relaxed uppercase">
                    <p>7-Day Exchange window | OneN Studio | Dhaka, Bangladesh</p>
                </div>
                <div class="text-right w-64">
                    <div class="flex justify-between text-[11px] font-bold mb-2"><span class="opacity-40 uppercase">Delivery Charge</span><span class="m-ship-val">0</span></div>
                    <div class="flex justify-between border-t-[3px] border-black pt-3 font-black">
                        <span class="text-[12px] mt-2 uppercase italic">Grand Total</span>
                        <div class="flex items-start"><span class="text-xl mt-1 mr-1">৳</span><span class="text-5xl m-total tracking-tighter">0</span></div>
                    </div>
                </div>
            </div>
            <button class="m-delete-btn no-print absolute top-4 right-4 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-trash-can"></i></button>
        </div>
    </template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // GLOBAL CONFIG
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' && __app_id ? __app_id : 'onen-studio-global';

        let memos = [];
        let inventory = [];
        let activeDocId = null;
        let currentUser = null;

        const Logger = {
            log: (msg) => {
                const el = document.getElementById('debug-console');
                el.innerHTML += `<div>> ${msg}</div>`;
                el.scrollTop = el.scrollHeight;
                console.log("[Engine]", msg);
            }
        };

        const Engine = {
            async init() {
                Logger.log(`Starting Engine (ID: ${appId})`);
                this.updateUIStatus('syncing', 'Connecting Auth...');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        Logger.log(`Auth Verified: ${user.uid}`);
                        currentUser = user;
                        this.updateUIStatus('online', 'Live');
                        this.startSync();
                    } else {
                        Logger.log("No User Session. Triggering Sign-In...");
                        await this.doAuth();
                    }
                });

                // Fallback timeout
                setTimeout(() => {
                    if (!currentUser) {
                        Logger.log("Auth timeout. Force Retrying...");
                        this.doAuth();
                    }
                }, 3000);

                this.bindGlobalEvents();
            },

            async doAuth() {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        Logger.log("Attempting Custom Token Auth...");
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        Logger.log("Attempting Anonymous Auth...");
                        await signInAnonymously(auth);
                    }
                } catch (e) {
                    Logger.log(`Auth Error: ${e.message}`);
                    this.updateUIStatus('offline', 'Auth Failed');
                }
            },

            updateUIStatus(status, label) {
                const el = document.getElementById('sync-indicator');
                if(!el) return;
                el.className = `text-[10px] flex items-center gap-1.5 font-bold mt-2 cursor-pointer ${status}`;
                el.querySelector('span').innerText = label;
            },

            startSync() {
                if (!currentUser) return;
                Logger.log("Attaching Firestore Listeners...");

                // Rule 1: /artifacts/{appId}/public/data/{collection}
                const memoRef = collection(db, 'artifacts', appId, 'public', 'data', 'memos');
                const invRef = collection(db, 'artifacts', appId, 'public', 'data', 'inventory');

                onSnapshot(memoRef, (snap) => {
                    Logger.log(`Memos Updated (${snap.size} docs)`);
                    const data = [];
                    snap.forEach(d => data.push({ ...d.data(), docId: d.id }));
                    memos = data.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    
                    if (memos.length > 0 && !activeDocId) activeDocId = memos[0].docId;
                    this.renderMemos();
                }, (err) => {
                    Logger.log(`Memos Error: ${err.message}`);
                    this.updateUIStatus('offline', 'Sync Lost');
                });

                onSnapshot(invRef, (snap) => {
                    Logger.log(`Inventory Updated (${snap.size} items)`);
                    inventory = [];
                    snap.forEach(d => inventory.push({ ...d.data(), id: d.id }));
                    this.renderInventoryTable();
                });
            },

            renderMemos() {
                const workspace = document.getElementById('workspace');
                const historyList = document.getElementById('history-list');
                
                // Hide initial loader once we have data or are connected
                const loader = document.getElementById('initial-loader');
                if (loader) loader.remove();

                workspace.innerHTML = '';
                historyList.innerHTML = '';

                if (memos.length === 0) {
                    workspace.innerHTML = `<div class="flex flex-col items-center justify-center h-[50vh] text-white/10 uppercase font-black tracking-widest text-[10px]">No orders found. Click "Create New Memo" to start.</div>`;
                    return;
                }

                memos.forEach(m => {
                    const isActive = m.docId === activeDocId;
                    const tpl = document.getElementById('memo-tpl').content.cloneNode(true);
                    const card = tpl.querySelector('.memo-card');
                    if (isActive) card.classList.add('active');

                    card.querySelector('.m-id').innerText = m.id;
                    card.querySelector('.m-date').innerText = m.date;
                    card.querySelector('.m-tag').innerText = m.tag || 'DHAKA';
                    card.querySelector('.m-ship-val').innerText = m.ship || 60;

                    const sTag = card.querySelector('.m-status-tag');
                    sTag.innerText = m.status;
                    sTag.className = `m-status-tag font-black text-[9px] uppercase px-3 py-1 border-[2px] rounded-full st-${(m.status || 'PENDING').toLowerCase()}`;

                    const bind = (sel, key) => {
                        const el = card.querySelector(sel);
                        el.value = m[key] || '';
                        el.onchange = (e) => this.updateMemo({ [key]: e.target.value.toUpperCase() }, m.docId);
                    };
                    bind('.m-name', 'name'); bind('.m-phone', 'phone'); bind('.m-addr', 'addr'); bind('.m-instructions', 'instructions');

                    let subtotal = 0;
                    const rows = card.querySelector('.m-rows');
                    (m.items || []).forEach((item, idx) => {
                        subtotal += (item.price * item.qty);
                        const tr = document.createElement('tr');
                        tr.className = "border-b border-black/5 group";
                        tr.innerHTML = `
                            <td class="py-3 opacity-20">${idx+1}</td>
                            <td class="py-3 uppercase text-[11px]">${item.name}</td>
                            <td class="text-center text-[11px]">${item.variant || '—'}</td>
                            <td class="text-center text-[11px] uppercase">${item.color || '—'}</td>
                            <td class="text-center font-black">
                                <div class="flex items-center justify-center gap-2 no-print">
                                    <button class="q-dec opacity-20 hover:opacity-100">×</button>
                                    <span>${item.qty}</span>
                                    <button class="q-inc opacity-20 hover:opacity-100">+</button>
                                </div>
                                <span class="hidden print:inline">${item.qty}</span>
                            </td>
                            <td class="text-right text-[12px]">${(item.price * item.qty).toLocaleString()}</td>
                            <td class="no-print text-right"><span class="row-remove-btn"><i class="fa-solid fa-xmark"></i></span></td>
                        `;
                        tr.querySelector('.q-inc').onclick = () => { m.items[idx].qty++; this.updateMemo({ items: m.items }, m.docId); };
                        tr.querySelector('.q-dec').onclick = () => { if(m.items[idx].qty > 1) { m.items[idx].qty--; this.updateMemo({ items: m.items }, m.docId); } };
                        tr.querySelector('.row-remove-btn').onclick = () => { m.items.splice(idx,1); this.updateMemo({ items: m.items }, m.docId); };
                        rows.appendChild(tr);
                    });

                    card.querySelector('.m-total').innerText = (subtotal + (m.ship || 60)).toLocaleString();
                    card.onclick = () => { if(activeDocId !== m.docId) { activeDocId = m.docId; this.renderMemos(); } };
                    card.querySelector('.m-delete-btn').onclick = (e) => { e.stopPropagation(); this.deleteMemo(m.docId); };
                    workspace.appendChild(card);

                    const hist = document.createElement('div');
                    hist.className = `p-4 glass cursor-pointer transition-all ${isActive ? 'border-amber-500 bg-white/5 opacity-100' : 'opacity-40 hover:opacity-100'}`;
                    hist.innerHTML = `<div class="text-[10px] font-black uppercase truncate text-white">${m.name || 'NEW ORDER'}</div><div class="flex justify-between mt-1 opacity-60 text-[8px] font-black"><span>${m.id}</span><span>${(subtotal + (m.ship || 60)).toLocaleString()}৳</span></div>`;
                    hist.onclick = () => { activeDocId = m.docId; this.renderMemos(); };
                    historyList.appendChild(hist);
                });
                this.syncSidebar();
            },

            syncSidebar() {
                const active = memos.find(m => m.docId === activeDocId);
                if (!active) return;
                document.querySelectorAll('[data-action="setLifecycle"]').forEach(btn => btn.classList.toggle('active-state', btn.dataset.state === active.status));
                document.querySelectorAll('[data-action="setType"]').forEach(btn => btn.classList.toggle('active-state', btn.dataset.type === active.type));
                document.querySelectorAll('[data-action="setShip"]').forEach(btn => btn.classList.toggle('active-state', parseInt(btn.dataset.val) === active.ship));
            },

            async updateMemo(data, id = null) {
                const tid = id || activeDocId;
                if(!tid || !currentUser) return;
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'memos', tid), data);
                } catch(e) { Logger.log(`Update Error: ${e.message}`); }
            },

            async deleteMemo(id) {
                if(confirm("Permanently delete this memo?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'memos', id));
                    if(activeDocId === id) activeDocId = null;
                }
            },

            async createNewMemo() {
                if(!currentUser) { Logger.log("Cannot create: Auth missing"); return; }
                const docId = Date.now().toString();
                const newMemo = {
                    id: '#' + Math.floor(1000 + Math.random() * 9000),
                    date: new Date().toLocaleDateString('en-GB'),
                    name: '', phone: '', addr: '', instructions: '', ship: 60, tag: 'DHAKA',
                    status: 'PENDING', type: 'REGULAR', items: [], createdAt: Date.now(),
                    owner: currentUser.uid
                };
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'memos', docId), newMemo);
                    activeDocId = docId;
                    Logger.log("Created New Memo");
                } catch(e) { Logger.log(`Create Error: ${e.message}`); }
            },

            bindGlobalEvents() {
                document.getElementById('btn-new-memo').onclick = () => this.createNewMemo();
                document.getElementById('btn-open-picker').onclick = () => this.openPicker();
                document.getElementById('btn-close-picker').onclick = () => this.closePicker();
                document.getElementById('btn-manage-inventory-cog').onclick = () => this.toggleInventoryModal(true);
                document.getElementById('btn-close-inventory').onclick = () => this.toggleInventoryModal(false);
                document.getElementById('btn-save-inv').onclick = () => this.saveInventoryItem();
                
                document.querySelectorAll('[data-action]').forEach(btn => {
                    btn.onclick = () => {
                        const action = btn.dataset.action;
                        if (action === 'setLifecycle') this.updateMemo({ status: btn.dataset.state });
                        if (action === 'setType') this.updateMemo({ type: btn.dataset.type });
                        if (action === 'setShip') this.updateMemo({ ship: parseInt(btn.dataset.val), tag: btn.dataset.tag });
                    };
                });

                document.getElementById('quick-parse').oninput = (e) => {
                    const val = e.target.value;
                    if(!val || !activeDocId) return;
                    const lines = val.split('\n').filter(l => l.trim());
                    const phone = (val.match(/01[3-9]\d{8}/) || [""])[0];
                    if (lines.length > 0) {
                        const name = lines[0].toUpperCase();
                        const addr = val.replace(lines[0], '').replace(phone, '').replace(/\n/g, ' ').trim();
                        this.updateMemo({ name, phone, addr });
                        setTimeout(() => { e.target.value = ''; }, 1000);
                    }
                };

                // Export buttons
                const exporters = ['steadfast', 'pathao', 'carrybee'];
                exporters.forEach(id => {
                    const el = document.getElementById(`btn-export-${id}`);
                    if(el) el.onclick = () => this.exportLogistics(id);
                });

                // Secret Debug Toggle: Hold Shift + D
                window.addEventListener('keydown', (e) => {
                    if (e.shiftKey && e.key === 'D') {
                        const dbg = document.getElementById('debug-console');
                        dbg.style.display = dbg.style.display === 'block' ? 'none' : 'block';
                    }
                });
            },

            openPicker() {
                if (!activeDocId) return;
                const modal = document.getElementById('picker-modal');
                const grid = document.getElementById('picker-grid');
                modal.classList.replace('hidden', 'flex');
                
                grid.innerHTML = inventory.length ? inventory.map(item => `
                    <div class="glass p-8 border-white/5 flex flex-col gap-6" id="picker-item-${item.id}">
                        <div class="flex justify-between items-start">
                            <h4 class="font-black uppercase text-xl text-white tracking-tighter">${item.name}</h4>
                            <span class="text-amber-500 font-bold">৳${item.price.toLocaleString()}</span>
                        </div>
                        <div class="space-y-4">
                            <div class="flex flex-wrap gap-2 size-selector">
                                ${(item.variants || []).map(v => `<button class="pill-btn size-opt" data-val="${v}">${v}</button>`).join('') || '<button class="pill-btn size-opt active-state" data-val="—">—</button>'}
                            </div>
                            <div class="flex flex-wrap gap-2 color-selector">
                                ${(item.colors || []).map(c => `<button class="pill-btn color-opt" data-val="${c}">${c}</button>`).join('') || '<button class="pill-btn color-opt active-state" data-val="—">—</button>'}
                            </div>
                        </div>
                        <button class="w-full bg-white text-black py-3 rounded-lg font-black text-[10px] uppercase tracking-widest btn-add-final">Add to Memo</button>
                    </div>
                `).join('') : '<div class="col-span-2 text-center py-20 opacity-20 font-black uppercase tracking-widest text-xs text-white">No items in catalog.</div>';

                inventory.forEach(item => {
                    const box = document.getElementById(`picker-item-${item.id}`);
                    if(!box) return;
                    let sZ = item.variants?.length ? null : '—', sC = item.colors?.length ? null : '—';
                    box.querySelectorAll('.size-opt').forEach(b => b.onclick = () => { box.querySelectorAll('.size-opt').forEach(x=>x.classList.remove('active-state')); b.classList.add('active-state'); sZ = b.dataset.val; });
                    box.querySelectorAll('.color-opt').forEach(b => b.onclick = () => { box.querySelectorAll('.color-opt').forEach(x=>x.classList.remove('active-state')); b.classList.add('active-state'); sC = b.dataset.val; });
                    box.querySelector('.btn-add-final').onclick = () => {
                        if(!sZ || !sC) { alert("Please select size/color first"); return; }
                        const m = memos.find(m => m.docId === activeDocId);
                        this.updateMemo({ items: [...(m.items || []), { name: item.name, variant: sZ, color: sC, price: item.price, qty: 1 }] });
                        this.closePicker();
                    };
                });
            },

            closePicker() { document.getElementById('picker-modal').classList.replace('flex', 'hidden'); },
            toggleInventoryModal(show) { 
                const m = document.getElementById('inventory-modal');
                m.classList.toggle('hidden', !show); 
                m.classList.toggle('flex', show);
            },

            async saveInventoryItem() {
                const name = document.getElementById('inv-name').value.trim().toUpperCase();
                const price = parseInt(document.getElementById('inv-price').value);
                const vars = document.getElementById('inv-vars').value.split(',').map(v => v.trim()).filter(v => v);
                const colors = document.getElementById('inv-colors').value.split(',').map(c => c.trim()).filter(c => c);

                if(!name || isNaN(price) || !currentUser) return;

                const itemId = Date.now().toString();
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', itemId), {
                        name, price, variants: vars, colors, createdAt: Date.now(), owner: currentUser.uid
                    });
                    document.getElementById('inv-name').value = '';
                    document.getElementById('inv-price').value = '';
                    Logger.log("Inventory Saved");
                } catch(e) { Logger.log(`Inventory Error: ${e.message}`); }
            },

            renderInventoryTable() {
                const tbody = document.getElementById('inv-table-body');
                tbody.innerHTML = inventory.map(item => `
                    <tr class="border-b border-white/5 group">
                        <td class="py-4 uppercase text-white">${item.name}</td>
                        <td class="py-4 text-amber-500 font-black">৳${item.price.toLocaleString()}</td>
                        <td class="py-4 opacity-50 text-[10px]">${(item.variants || []).join(', ')}</td>
                        <td class="py-4 opacity-50 uppercase text-[10px]">${(item.colors || []).join(', ')}</td>
                        <td class="py-4 text-right">
                            <button onclick="window.delInv('${item.id}')" class="text-red-500/30 hover:text-red-500 transition-colors p-2"><i class="fa-solid fa-trash-can"></i></button>
                        </td>
                    </tr>
                `).join('');
                window.delInv = async (id) => { if(confirm("Remove item?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', id)); };
            },

            exportLogistics(p) {
                if (!memos.length) return;
                const rows = memos.map(m => {
                    const total = (m.items || []).reduce((a, b) => a + (b.price * b.qty), 0) + (m.ship || 60);
                    if(p === 'steadfast') return [m.id, m.name, m.phone, m.addr, total, m.instructions || ''];
                    if(p === 'pathao') return ["ONEN STUDIO", m.id, m.name, m.phone, m.addr, m.tag || 'DHAKA', total, m.instructions || ''];
                    return [m.name, m.phone, m.addr, total, m.id, m.instructions || ''];
                });
                const heads = p === 'steadfast' ? ["Invoice","Name","Contact","Address","Amount","Note"] : p === 'pathao' ? ["Store","OrderID","RecipientName","RecipientPhone","RecipientAddress","City","Amount","Note"] : ["Customer Name","Phone Number","Full Address","Collection Amount","Reference ID","Instructions"];
                const content = [heads.join(','), ...rows.map(r => r.map(c => `"${String(c).replace(/,/g, ' ')}"`).join(','))].join('\n');
                const b = new Blob([content], { type: 'text/csv' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `ONEN_${p}.csv`; a.click();
            }
        };

        window.onload = () => Engine.init();
    </script>
</body>
</html>
