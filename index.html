import React, { useState, useEffect, useRef } from 'react';
import { 
  Plus, Trash2, StickyNote, Calendar, FileDown, 
  History, Box, ChevronRight, Minus, Package,
  LayoutDashboard
} from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';

const App = () => {
  const [memos, setMemos] = useState([]);
  const [newMemo, setNewMemo] = useState('');
  const [inventory, setInventory] = useState({ color: '', size: '', quantity: 1 });
  const [isSidebarOpen, setIsSidebarOpen] = useState(true);
  const memoRefs = useRef({});

  // Initialize from localStorage
  useEffect(() => {
    const saved = localStorage.getItem('inventory-memo-data');
    if (saved) {
      try {
        setMemos(JSON.parse(saved));
      } catch (e) {
        console.error("Failed to parse saved data");
      }
    }
  }, []);

  // Auto-save whenever memos change
  useEffect(() => {
    localStorage.setItem('inventory-memo-data', JSON.stringify(memos));
  }, [memos]);

  const addEntry = () => {
    if (!newMemo.trim()) return;
    const entry = {
      id: `memo-${Date.now()}`,
      text: newMemo,
      inventory: { ...inventory },
      date: new Date().toLocaleString(),
      bgColor: getRandomColor()
    };
    setMemos([entry, ...memos]);
    // Reset form
    setNewMemo('');
    setInventory({ color: '', size: '', quantity: 1 });
  };

  const deleteMemo = (id) => {
    setMemos(memos.filter(m => m.id !== id));
  };

  const getRandomColor = () => {
    const colors = ['bg-blue-50', 'bg-emerald-50', 'bg-rose-50', 'bg-amber-50', 'bg-violet-50', 'bg-sky-50'];
    return colors[Math.floor(Math.random() * colors.length)];
  };

  const handleExportPDF = () => {
    window.print();
  };

  const scrollToMemo = (id) => {
    memoRefs.current[id]?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    // Add a temporary highlight effect
    const element = memoRefs.current[id];
    element.style.ring = "4px solid #3b82f6";
    setTimeout(() => { element.style.ring = "none"; }, 2000);
  };

  const updateQty = (val) => {
    setInventory(prev => ({ ...prev, quantity: Math.max(1, prev.quantity + val) }));
  };

  return (
    <div className="flex h-screen bg-slate-50 font-sans text-slate-900 overflow-hidden">
      {/* Sidebar / History Section */}
      <motion.aside 
        initial={false}
        animate={{ width: isSidebarOpen ? '300px' : '0px', opacity: isSidebarOpen ? 1 : 0 }}
        className="bg-white border-r border-slate-200 overflow-hidden hidden md:flex flex-col print:hidden"
      >
        <div className="p-6 border-b border-slate-100 flex items-center justify-between">
          <h2 className="font-bold flex items-center gap-2">
            <History size={18} className="text-blue-500" />
            History
          </h2>
          <span className="text-xs bg-slate-100 px-2 py-1 rounded-full text-slate-500">{memos.length}</span>
        </div>
        <div className="flex-1 overflow-y-auto p-4 space-y-2">
          {memos.map(m => (
            <button
              key={m.id}
              onClick={() => scrollToMemo(m.id)}
              className="w-full text-left p-3 rounded-xl hover:bg-slate-50 border border-transparent hover:border-slate-100 transition-all group"
            >
              <p className="text-sm font-medium truncate text-slate-700">{m.text}</p>
              <div className="flex items-center justify-between mt-1">
                <span className="text-[10px] text-slate-400">{m.date.split(',')[0]}</span>
                <ChevronRight size={12} className="text-slate-300 group-hover:text-blue-400 transition-transform group-hover:translate-x-1" />
              </div>
            </button>
          ))}
        </div>
      </motion.aside>

      {/* Main Content Area */}
      <main className="flex-1 flex flex-col overflow-y-auto scroll-smooth print:overflow-visible">
        <div className="max-w-5xl mx-auto w-full p-4 md:p-10">
          
          {/* Header */}
          <header className="mb-10 flex flex-col md:flex-row md:items-center justify-between gap-4 print:hidden">
            <div>
              <div className="flex items-center gap-3">
                <button 
                  onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                  className="p-2 hover:bg-white rounded-lg border border-transparent hover:border-slate-200 transition-all"
                >
                  <LayoutDashboard size={20} className="text-slate-600" />
                </button>
                <h1 className="text-3xl font-black text-slate-800 tracking-tight flex items-center gap-2">
                  Inventory<span className="text-blue-600">Sync</span>
                </h1>
              </div>
              <p className="text-slate-500 ml-12 mt-1">Track items and thoughts in one place.</p>
            </div>
            <button
              onClick={handleExportPDF}
              className="flex items-center gap-2 bg-white border border-slate-200 px-5 py-2.5 rounded-xl font-semibold text-slate-700 hover:bg-slate-50 transition-all shadow-sm active:scale-95"
            >
              <FileDown size={18} />
              Export PDF
            </button>
          </header>

          <div className="hidden print:block mb-8">
            <h1 className="text-2xl font-bold">Inventory & Memo Report</h1>
            <p className="text-slate-500">Generated on: {new Date().toLocaleString()}</p>
          </div>

          {/* Input Section */}
          <motion.div 
            whileHover={{ y: -2 }}
            className="bg-white rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-200 p-6 mb-12 print:hidden"
          >
            <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
              {/* Text Area */}
              <div className="lg:col-span-7 flex flex-col gap-3">
                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                  <StickyNote size={14} /> Memo Content
                </label>
                <textarea
                  placeholder="What are we tracking today?..."
                  className="w-full p-4 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-blue-100 focus:bg-white focus:ring-0 transition-all resize-none min-h-[140px] text-lg"
                  value={newMemo}
                  onChange={(e) => setNewMemo(e.target.value)}
                />
              </div>

              {/* Inventory Details */}
              <div className="lg:col-span-5 flex flex-col gap-4">
                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                  <Package size={14} /> Item Details
                </label>
                
                <div className="grid grid-cols-2 gap-3">
                  <div className="space-y-1">
                    <span className="text-[10px] ml-1 text-slate-400 font-bold uppercase">Color</span>
                    <input 
                      type="text" 
                      placeholder="Red, Blue..." 
                      className="w-full p-3 rounded-xl bg-slate-50 border-none text-sm focus:ring-2 focus:ring-blue-500/20"
                      value={inventory.color}
                      onChange={(e) => setInventory({...inventory, color: e.target.value})}
                    />
                  </div>
                  <div className="space-y-1">
                    <span className="text-[10px] ml-1 text-slate-400 font-bold uppercase">Size</span>
                    <input 
                      type="text" 
                      placeholder="XL, 42..." 
                      className="w-full p-3 rounded-xl bg-slate-50 border-none text-sm focus:ring-2 focus:ring-blue-500/20"
                      value={inventory.size}
                      onChange={(e) => setInventory({...inventory, size: e.target.value})}
                    />
                  </div>
                </div>

                <div className="space-y-1">
                  <span className="text-[10px] ml-1 text-slate-400 font-bold uppercase">Quantity</span>
                  <div className="flex items-center bg-slate-50 p-1 rounded-xl">
                    <button onClick={() => updateQty(-1)} className="p-2 hover:bg-white rounded-lg transition-all text-slate-500 shadow-sm"><Minus size={16}/></button>
                    <input 
                      type="number" 
                      className="flex-1 bg-transparent border-none text-center font-bold text-lg focus:ring-0"
                      value={inventory.quantity}
                      onChange={(e) => setInventory({...inventory, quantity: parseInt(e.target.value) || 1})}
                    />
                    <button onClick={() => updateQty(1)} className="p-2 hover:bg-white rounded-lg transition-all text-blue-500 shadow-sm"><Plus size={16}/></button>
                  </div>
                </div>

                <motion.button
                  whileTap={{ scale: 0.95 }}
                  onClick={addEntry}
                  className="mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-2xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-blue-200 transition-all"
                >
                  <Plus size={20} />
                  Add to Inventory
                </motion.button>
              </div>
            </div>
          </motion.div>

          {/* Memos Grid */}
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-6 pb-20 print:grid-cols-1">
            <AnimatePresence mode="popLayout">
              {memos.length === 0 ? (
                <motion.div 
                  initial={{ opacity: 0 }} animate={{ opacity: 1 }}
                  className="col-span-full py-20 text-center border-4 border-dashed border-slate-200 rounded-[40px] print:hidden"
                >
                  <Package className="text-slate-300 mx-auto mb-4" size={48} />
                  <h3 className="text-xl font-bold text-slate-400">Inventory is empty</h3>
                </motion.div>
              ) : (
                memos.map((memo) => (
                  <motion.div
                    layout
                    key={memo.id}
                    ref={el => memoRefs.current[memo.id] = el}
                    initial={{ opacity: 0, scale: 0.8, y: 20 }}
                    animate={{ opacity: 1, scale: 1, y: 0 }}
                    exit={{ opacity: 0, scale: 0.5, transition: { duration: 0.2 } }}
                    whileHover={{ scale: 1.02 }}
                    transition={{ type: "spring", stiffness: 300, damping: 20 }}
                    className={`${memo.bgColor} border border-slate-200/60 rounded-[32px] p-6 flex flex-col h-full min-h-[260px] shadow-sm relative group print:bg-white print:border-slate-300 print:min-h-0 print:mb-4`}
                  >
                    {/* Inventory Badge Container */}
                    <div className="flex flex-wrap gap-2 mb-4">
                      {memo.inventory.color && (
                        <span className="px-3 py-1 bg-white/60 border border-slate-200 rounded-full text-[10px] font-black uppercase tracking-widest text-slate-600">
                          Color: {memo.inventory.color}
                        </span>
                      )}
                      {memo.inventory.size && (
                        <span className="px-3 py-1 bg-white/60 border border-slate-200 rounded-full text-[10px] font-black uppercase tracking-widest text-slate-600">
                          Size: {memo.inventory.size}
                        </span>
                      )}
                      <span className="px-3 py-1 bg-blue-600 text-white rounded-full text-[10px] font-black uppercase tracking-widest shadow-lg shadow-blue-200">
                        Qty: {memo.inventory.quantity}
                      </span>
                    </div>

                    <div className="flex-grow overflow-y-auto mb-4 scrollbar-hide">
                      <p className="whitespace-pre-wrap break-words text-slate-800 text-lg font-medium leading-relaxed">
                        {memo.text}
                      </p>
                    </div>

                    <div className="pt-4 border-t border-slate-900/5 flex items-center justify-between mt-auto">
                      <div className="flex items-center gap-2 text-slate-400 text-[10px] font-bold uppercase tracking-tighter">
                        <Calendar size={12} />
                        {memo.date}
                      </div>
                      <button
                        onClick={() => deleteMemo(memo.id)}
                        className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-xl transition-all opacity-0 group-hover:opacity-100 print:hidden"
                      >
                        <Trash2 size={18} />
                      </button>
                    </div>
                  </motion.div>
                ))
              )}
            </AnimatePresence>
          </div>
        </div>
      </main>

      <style>{`
        @media print {
          .print\:hidden { display: none !important; }
          body { background-color: white !important; }
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
      `}</style>
    </div>
  );
};

export default App;
